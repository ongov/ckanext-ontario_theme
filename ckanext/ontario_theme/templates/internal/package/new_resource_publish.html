{% extends "package/resource_edit_base.html" %}

{% block pre_primary %}
{% endblock pre_primary %}

{% block page_header %}
{% endblock page_header %}

{% block form_title %}
  {{ _('Review and publish') }}
{% endblock form_title %}

{% block primary_content_inner %}
  {% set href_metadata = url_for('resource.edit', id=pkg.name, resource_id=resource_id) %}
  {%- set exclude_fields = ["url", "format", "schema", "validation_options", "validation_status", "validation_timestamp"] -%}
  <div class="ontario-summary-list">
    <div class="ontario-summary-list-heading__container">
      <h2 class="ontario-summary-list__heading">Data source</h2>
      <div class="ontario-summary-list-heading__buttons">
          <a class="ontario-summary-list-change__button" href="{{ href_metadata }}">
            Change
            <span class="ontario-show-for-sr">your answer for: <q>Data source</q></span>
          </a>
      </div>
    </div>
    <dl class="ontario-summary-list__container">
      <div class="ontario-summary-list__row">
          <dt class="ontario-summary-list__key">
              Data source
          </dt>
          <dd class="ontario-summary-list__value break-word">
              {{ resource.url.split('download/')[-1] }}
          </dd>
      </div>
      <div class="ontario-summary-list__row">
          <dt class="ontario-summary-list__key">
              Format type
          </dt>
          <dd class="ontario-summary-list__value">
              {{ resource.format }}
          </dd>
      </div>
    </dl>
  </div>
  <div class="ontario-summary-list">
    <div class="ontario-summary-list-heading__container">
        <h2 class="ontario-summary-list__heading">Metadata</h2>
        <div class="ontario-summary-list-heading__buttons">
            <a class="ontario-summary-list-change__button" href="{{ href_metadata }}">
                Change
                <span class="ontario-show-for-sr">your answer for: <q>Metadata</q></span>
            </a>
        </div>
    </div>
    <dl class="ontario-summary-list__container">
      {% set schema = h.scheming_get_dataset_schema(dataset_type) %}
        {%- for field in schema.resource_fields -%}
          {%- if field.form_snippet is not none and field.field_name not in exclude_fields -%}
            {% set pkg_field = field.field_name %}
            {% if resource.get(pkg_field) is mapping %}
              {% for key, value in resource.get(pkg_field).items() %}
                <div class="ontario-summary-list__row">
                  <dt class="ontario-summary-list__key">
                    {{ key.upper() }} {{ h.scheming_language_text(field.label) }}
                  </dt>
                  <dd class="ontario-summary-list__value">
                    {{ value }}
                  </dd>
                </div>
              {% endfor %}
            {% else %}
              <div class="ontario-summary-list__row">
                <dt class="ontario-summary-list__key">
                  {{ h.scheming_language_text(field.label) }}
                </dt>
                <dd class="ontario-summary-list__value break-word">
                  {%- if field.preset == "date" -%}
                    {{- h.render_datetime(resource[field.field_name]) -}}
                  {%- else -%}
                    {%- snippet "scheming/snippets/display_field.html", field=field, data=resource, entity_type='dataset', object_type=dataset_type -%}
                  {%- endif -%}
                </dd>
              </div>
          {% endif %}
        {%- endif -%}
      {%- endfor -%}
    </dl>
  </div>

  <div class="ontario-summary-list">
    <div class="ontario-summary-list-heading__container">
      <h2 class="ontario-summary-list__heading">Data dictionary</h2>
      <div class="ontario-summary-list-heading__buttons">
        {% set href_data_dictionary = url_for('datastore.dictionary', id=pkg.name, resource_id=resource_id) %}
          <a class="ontario-summary-list-change__button" href="{{ href_data_dictionary }}">
            Change
            <span class="ontario-show-for-sr">your answer for: <q>Data dictionary</q></span>
          </a>
      </div>
    </div>
    {% if resource.format == 'CSV' %}
      {% set fields = h.datastore_dictionary(resource_id) %}
      {#- Example of returned dictionary with type override:
            [{'id': 'rule',
              'type': 'text',
              'info': { 'notes': '',
                        'type_override': '',
                        'frictionless_dict': [{'type': 'string', 'name': 'rule'}]}},
            {'id': 'integercol',
              'type': 'int4',
              'info': { 'notes': '',
                        'type_override': 'integer',
                        'frictionless_dict': [{'type': 'integer', 'name': 'integercol'}]}}]

            "type" is not human-readable for non-text types (e.g. int4), so use
            field.info["type_override"] (e.g. integer) for these cases. Note we want to
            stick with the PostgreSQL type names (e.g. "text" not "string") so don't use
            field.info["frictionless_dict"]["type"].

          A returned dictionary without any type overrides looks like:
            [{'id': 'rule', 'type': 'text'},
            {'id': 'integercol', 'type': 'text'}]
      -#}
      {% for field in fields %}
        <h3 class="data-dictionary-columns">Column {{ loop.index }}</h3>
        {% if field.info %}
          {% set field_type = field.type if field.info["type_override"] == '' else field.info["type_override"] %}
          {% set field_notes = field.info["notes"] %}
        {% else %}
          {% set field_type = field.type %}
          {% set field_notes = "" %}
        {% endif %}
        <dl class="ontario-summary-list__container">
          <div class="ontario-summary-list__row">
              <dt class="ontario-summary-list__key">
                Column name
              </dt>
              <dd class="ontario-summary-list__value break-word">
                {{ field.id }}
              </dd>
          </div>
          <div class="ontario-summary-list__row">
              <dt class="ontario-summary-list__key">
                Data type
              </dt>
              <dd class="ontario-summary-list__value">
                {{ field_type }}
              </dd>
          </div>
          <div class="ontario-summary-list__row">
              <dt class="ontario-summary-list__key">
                Description
              </dt>
              <dd class="ontario-summary-list__value">
                {{ field_notes }}
              </dd>
          </div>
        </dl>
      {% endfor %}
    {% else %}
      <p>Not applicable for this resource.</p>
    {% endif %}
  </div>
  {% link_for _('Publish resource'), named_route='dataset.read', id=pkg.name, class_="ontario-button ontario-button--primary" %}
{% endblock primary_content_inner %}

{% block secondary %}
{% endblock secondary %}
