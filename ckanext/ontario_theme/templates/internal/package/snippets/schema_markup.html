{%- set license = license if license is defined else h.ontario_theme_get_license(pkg.license_id) -%}
{# CKAN 2.11 updates for license and keywords to handle when they are null #}
{# lic might be None; guard it and prefer translated text if present #}
{% set lic_obj = license if license is not none else None %}
{% set lic_dict = lic_obj.license_dictize() if lic_obj else {} %}

{# Prefer translated description/title if available, else raw fields, else empty #}
{% set lic_descr = (
  (h.get_translated(lic_dict, 'description') if lic_dict.get('description_translated') else lic_dict.get('description'))
  or (h.get_translated(lic_dict, 'title') if lic_dict.get('title_translated') else lic_dict.get('title'))
  or ''
) %}

# Get the current-language list from keywords_translated #}
{% set kw = h.get_translated(pkg, 'keywords') 
              or h.get_translated(pkg, 'keywords_translated') 
              or [] %}

{# Ensure it's a list, not a string #}
{% if kw is string %}{% set kw = [kw] %}{% endif %}

{%- if h.scheming_field_by_name(schema.dataset_fields, 'notes_translated') and pkg.notes %}
  {% set description = h.scheming_language_text(pkg['notes_translated'])|truncate(5000, true) %}
{%- endif -%}
{% block javascript %}
<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "Dataset",
    "name": "{{ h.dataset_display_name(pkg) }}",
    "url": "https://data.ontario.ca{{ h.url_for('dataset.read', id=pkg.name) }}",
    {% for field in schema.dataset_fields -%}
      {%- if field.display_itemprop and pkg[field.field_name] -%}
        {%- set display_value = pkg[field.field_name] if not (pkg[field.field_name][h.lang()] or pkg[field.field_name][h.lang()] == "") else pkg[field.field_name][h.lang()] -%}
        "{{ field.display_itemprop }}": "{{ display_value }}",
      {%- endif -%}
    {%- endfor %}
    "includedInDataCatalog": {
      "@type": "DataCatalog",
      "url": "https://data.ontario.ca/"
    },
    "creator": {
      "@type": "Organization",
      "name": "{{ pkg.organization.title }}"
    },
    "description": "{{ description }}",
    "license": {
      "@type": "CreativeWork",
      "name": "{{ pkg.license_title }}",
      "text": "{{ lic_descr|e }}",
      "url": "{{ pkg.license_url }}"
    },
    "dateModified": "{{ pkg.metadata_modified }}",
    "temporal": "{{ pkg.current_as_of }}",
    "keywords": "{{ kw | join(',') }}",
    {% if pkg.access_level == 'open' -%}
      "distribution": [
        {% for res in resources -%}
          {% if res.data_range_start and not res.data_range_end -%}
            {% set temporalCoverage = res.data_range_start + "/.." %}
          {%- endif -%}
          {% if res.data_range_start and res.data_range_end -%}
            {% set temporalCoverage = res.data_range_start + "/" + res.data_range_end %}
          {%- endif -%}
            {
            "@type": "DataDownload",
            "contentUrl": "{{ res.url }}",
            "encodingFormat": "{{ res.format }}",
            "contentSize": "{{ res.size }}",
            "inLanguage": "{{ res.language }}",
            "name": "{{ h.get_translated(res, 'name') }}",
            "temporalCoverage": "{{ temporalCoverage }}"
          }{%- if not loop.last -%},{%- endif -%}
        {%- endfor %}
      ]
    {% endif %}
  }
</script>
{% endblock javascript %}