{% extends "package/resource_edit_base.html" %}

{%- block subtitle -%}
  {{ h.resource_display_name(resource) }}
{%- endblock subtitle -%}

{% block pre_primary %}
  {% set back_url = h.url_for(pkg_dict.type ~ '_resource.edit', id=pkg_dict.id, resource_id=resource.id) %}
  {% snippet "package/snippets/step_indicator.html", step=2, back_url=back_url %}
{% endblock pre_primary %}

{% block form_title %}
  {{ h.resource_display_name(resource) }}
  {% if validation.report %}{{ h.get_validation_badge(resource)|safe }}{% endif %}
{% endblock form_title %}

{% block primary_content_inner %}
  {% set package_id = resource.get('package_id') %}
  {% set resource_id = resource.get('id') %}
  {% set action = h.url_for('datastore.dictionary',
      id=package_id,
    resource_id=resource.id) %}
  {% set format = resource.format %}

  {# Spinner for validation #}
  <div id="div-vspinner" class="ontario-small-12 ontario-row">
    <div class="ontario-small-12 ontario-columns">
      <div id="loadingVSpinner"           
           aria-hidden='false'
           role='alert'
           aria-live='assertive'>
        <div class='ontario-loading-indicator'>
          <svg id="vspinnerSVG"
               class='ontario-loading-indicator__spinner-small'
               viewBox="25 25 50 50"
               xmlns='http://www.w3.org/2000/svg'>
            <circle cx="50" cy="50" r="20" fill="none" stroke-width="4" />
          </svg>
          <p class="spinner-small" id="pendingVTxt">Validating table structure</p>
        </div>
      </div>
    </div>
  </div>

  {% set success_message = "Data validated successfully" %}
  <div id="alert-outer" style="visibility: hidden;" class="validation-details">
    <p>validation.report: {{validation.report}}</p>
    {% snippet "package/snippets/successful_page_alert.html", success_message=success_message %}
  </div>

  <div id="alert_fail">    
  {% if validation.report %}
    {% if not validation.report.valid  %}
    <p>validation.report: {{validation.report}}</p>
        <div id="alert-invalid" class="ontario-alert ontario-alert--error">
          <div class="ontario-alert__header">
            <div class="ontario-alert__header-icon">
              <svg class="ontario-icon"
                  alt=""
                  aria-hidden="true"
                  focusable="false"
                  sol:category="primary"
                  viewBox="0 0 24 24"
                  preserveAspectRatio="xMidYMid meet">
                <use href="#ontario-icon-alert-error"></use>
              </svg>
            </div>
            <h2 class="ontario-alert__header-title ontario-h4">There is a problem</h2>
          </div>
          <div class="ontario-alert__body">
            <p>
              <a href="#validation-report"
                data-module="modal-dialog"
                data-module-div="validation-report-dialog">Show validation report.</a>
            </p>
            <p>Please go back to Step 1 and upload a corrected file.</p>
          </div>
          {# class="modal fade" #}
          <div id="validation-report-dialog" style="display: block;">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                    <h3>
                      {{ _('Data Validation Report') }}
                      <button class="close" data-dismiss="modal">Ã—</button>
                    </h3>
                </div>
                <div class="modal-body">

                  <div id="report" data-module="validation-report" data-module-report="{{ validation.report }}"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        {% set validation_report = h.ontario_theme_get_validation_report(resource.id) %}
        {% snippet 'validation/snippets/validation_report_dialog.html', validation_report=validation_report %}
      {% endif %}
    {% endif %}
  </div>
 


  {% if format == "CSV" %}
    <script>      
      const resId = "{{ resource.id }}";

      function poll_datastore() {
        const status_ok = ('complete', 'running_but_viewable');
        const xhr = new XMLHttpRequest();
        const url = `/api/3/action/xloader_status?resource_id=${resId}`;

        xhr.open("POST", url, true);
        xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        xhr.send();
        console.log('poll_datastore xhr: ', xhr)

        xhr.onreadystatechange = () => {
          if (xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
            let thisResponse = JSON.parse(xhr.response);

            if (thisResponse.result.status !== "pending") { //thisResponse.result.status.includes(status_ok)
              const sleep = (delay) => new Promise((resolve) => setTimeout(resolve, delay))
        
              const fixedDelay = async () => {
                await sleep(2000)
                document.getElementById("pendingTxt").innerHTML = "Data file uploaded. Please click Continue.";
                document.getElementById("spinnerSVG").style.visibility = "hidden";
                document.getElementById("step2Btn").style.visibility = "visible";
              }
              fixedDelay();

            } else {
            console.log('Request pending....set the timeout and retry...')
            setTimeout(poll_datastore, 1000);
            }
          }
        }
      };

      function poll_validation() {
        const xhr = new XMLHttpRequest();
        const url = `/api/3/action/resource_validation_show?resource_id=${resId}`;
        const validationStatus = ["created", "running"];

        xhr.open("POST", url, true);
        xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        xhr.send();
        console.log('poll_validation xhr: ', xhr)
            
        xhr.onreadystatechange = () => {
          if (xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
            let thisResponse = JSON.parse(xhr.response);
            console.log('thisResponse: ', thisResponse)
            console.log('thisResponse.result: ', thisResponse.result)
            console.log('thisResponse.result.status: ', thisResponse.result.status)

            if (!validationStatus.includes(thisResponse.result.status)) {
              console.log('not running anymore: ', thisResponse.result.status)
              if (thisResponse.result.status == "failure") {
                console.log('validation failed, show error alert for: ', thisURL)

                const element = document.getElementById("div-vspinner");
                element.remove();
                const elementSuccess = document.getElementById("alert-outer");
                elementSuccess.remove();

                thisURL = window.location.href;
                
                $("#alert_fail").load(`${thisURL} #alert-invalid`);


              } else if (thisResponse.result.status == "success") {
                const element = document.getElementById("div-vspinner");
                element.remove();

                console.log('validation success, upload to datastore')
                document.getElementById("alert-outer").style.visibility = "visible";
                
                poll_datastore();
                document.getElementById("loadingSpinner").style.visibility = "visible";
              }

            } else if (validationStatus.includes(thisResponse.result.status)) {
              console.log('Validation running....set the timeout and retry...')
              setTimeout(poll_validation, 1000);
            }
          }
        }
      };

      poll_validation();


    </script>


    <div class="ontario-small-12 ontario-row">
      <div class="ontario-small-12 ontario-columns">
        <div id="loadingSpinner"
             style="visibility: hidden;"
             aria-hidden='false'
             role='alert'
             aria-live='assertive'>
          <div class='ontario-loading-indicator'>
            <svg id="spinnerSVG"
                 class='ontario-loading-indicator__spinner-small'
                 viewBox="25 25 50 50"
                 xmlns='http://www.w3.org/2000/svg'>
              <circle cx="50" cy="50" r="20" fill="none" stroke-width="4" />
            </svg>
            <p class="spinner-small" id="pendingTxt">Uploading data file to database</p>
          </div>
        </div>
      </div>
    </div>

    <a href="{{ action }}">
      <button id="step2Btn"
              style="visibility: hidden;
                     margin-top: 40px;
                     margin-left: 36px"
              class="ontario-button ontario-button--primary"
              name="save"
              type="submit">Continue</button>
    </a>
  {% else %}
    {% set success_message = "Data uploaded successfully" %}
    {% snippet "package/snippets/successful_page_alert.html", success_message=success_message %}
    <a href="{{ action }}">
      <button id="nextBtn"
              class="ontario-button ontario-button--primary"
              name="save"
              type="submit">Continue</button>
    </a>
  {% endif %}
{% endblock primary_content_inner %}
