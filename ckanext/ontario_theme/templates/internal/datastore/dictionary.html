{% extends "package/resource_edit_base.html" %}

{% import 'macros/form.html' as form %}

{% block subtitle %}
  {{ h.dataset_display_name(pkg) }} - {{ h.resource_display_name(res) }}
{% endblock subtitle %}

{% block pre_primary %}
  {% set back_url = h.url_for(pkg.type ~ '_resource.edit', id=pkg.name, resource_id=res.id) %}
  {% snippet "package/snippets/step_indicator.html", step=3, back_url=back_url %}
{% endblock pre_primary %}

{% block page_header %}
{% endblock page_header %}

{% block form_title %}
  {% set in_datastore = h.ontario_theme_get_xloader_status(res, pkg) %}
  {% if in_datastore in ("yes", "not_csv") %}{{ _('Add data dictionary') }}{% endif %}
{% endblock form_title %}

{% block primary_content_inner %}
  {% set in_datastore = h.ontario_theme_get_xloader_status(res, pkg) %}
  {% if in_datastore in ("yes", "not_csv") %}
    {% if fields %}
      {% set action = h.url_for('datastore.dictionary', id=pkg.name, resource_id=res.id) %}
      {% set method = "method=post" %}
    {% else %}
      {% set action = h.url_for('ontario_theme.new_resource_publish', id=pkg.name, resource_id=res.id) %}
    {% endif %}

    {% if res.validation_status and res.validation_status == 'failure' %}
      <div class="ontario-alert ontario-alert--error">
        <div class="ontario-alert__header">
          <div class="ontario-alert__header-icon">
            <svg class="ontario-icon"
                 alt=""
                 aria-hidden="true"
                 focusable="false"
                 sol:category="primary"
                 viewBox="0 0 24 24"
                 preserveAspectRatio="xMidYMid meet">
              <use href="#ontario-icon-alert-error"></use>
            </svg>
          </div>
          <h2 class="ontario-alert__header-title ontario-h4">There is a problem</h2>
        </div>
        <div class="ontario-alert__body">
          <p>
            Data dictionary didnâ€™t match the uploaded resource file.
            <a href="#validation-report"
               data-module="modal-dialog"
               data-module-div="validation-report-dialog">Show validation report modal</a>
          </p>
          <p>You can either:</p>
          <ul>
            <li>Edit the data dictionary information on this page or</li>
            <li>Upload a corrected data resource file on Step 2</li>
          </ul>
        </div>
      </div>
      {% set validation_report = h.ontario_theme_get_validation_report(res.id) %}
      {% snippet 'validation/snippets/validation_report_dialog.html', validation_report=validation_report %}
    {% endif %}

    <form {{ method }} action="{{ action }}">
      {% if fields %}
        {% block dictionary_form %}
          {% for field in fields %}
            {% snippet "datastore/snippets/dictionary_form.html",
            field=field,
            position=loop.index
            %}
          {% endfor %}
        {% endblock dictionary_form %}
      {% else %}
        <p>This resource does not need a data dictionary.</p>
        <p>
          Data dictionaries give users the information they need to understand the data they are looking at. The data dictionary is displayed alongside the data for easy reference.
          Data dictionaries are only used for CSV files.
        </p>
      {% endif %}
      <button class="ontario-button ontario-button--primary"
              name="save"
              type="submit">{{ _('Continue') }}</button>
    </form>
  {% elif in_datastore == "pending" %}
    <div class="ontario-alert ontario-alert--error">
      <div class="ontario-alert__header">
        <div class="ontario-alert__header-icon">
          <svg class="ontario-icon"
               alt=""
               aria-hidden="true"
               focusable="false"
               sol:category="primary"
               viewBox="0 0 24 24"
               preserveAspectRatio="xMidYMid meet">
            <use href="#ontario-icon-alert-error"></use>
          </svg>
        </div>
        <h2 class="ontario-alert__header-title ontario-h4">Uploading...</h2>
      </div>
      <div class="ontario-alert__body">
        <p>The resource file is not yet uploaded to the database. Please refresh.</p>
        <p>
          If the resource file is large (> 100 MB) or your internet connection is
          slow, this may take a few minutes.
        </p>
      </div>
    </div>

    {% set poll_datastore = h.ontario_theme_poll_datastore(res, pkg) %}
    <form method="get" action="{{ poll_datastore }}">
      <button class="ontario-button ontario-button--primary"
              name="save"
              type="submit">Refresh</button>
    </form>
  {% endif %}
{% endblock primary_content_inner %}
