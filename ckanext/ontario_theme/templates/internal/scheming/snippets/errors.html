{% ckan_extends %}

{% set validation_report = h.validation_extract_report_from_errors(errors.copy()) %}
{% block errors_list %}
  <div class="ontario-alert ontario-alert--error">    
      <div class="ontario-alert__header">
        <div class="ontario-alert__header-icon">
          <svg class="ontario-icon"
                alt=""
                aria-hidden="true"
                focusable="false"
                sol:category="primary"
                viewBox="0 0 24 24"
                preserveAspectRatio="xMidYMid meet">
            <use href="#ontario-icon-alert-error"></use>
          </svg>
        </div>
        <h2 class="ontario-alert__header-title ontario-h4">There is a problem</h2>
      </div>

    <ul>
      {% block all_errors %}
        {%- for field in fields -%}
          {%- if 'error_snippet' in field -%}
            {%- set error_snippet = field.error_snippet -%}

            {%- if '/' not in error_snippet -%}
              {%- set error_snippet = 'scheming/error_snippets/' +
                error_snippet -%}
            {%- endif -%}

            {%- snippet error_snippet, unprocessed=unprocessed,
              field=field, fields=fields,
              entity_type=entity_type, object_type=object_type -%}
          {%- endif -%}

          {%- if field.field_name in unprocessed -%}
            {%- set errors = unprocessed.pop(field.field_name) -%}
            {%- if 'repeating_subfields' in field %}
              {%- for se in errors -%}
                {%- if se -%}
                  <li data-field-label="{{ field.field_name }}-{{ loop.index }}">{{
                    h.scheming_language_text(field.repeating_label or field.label) }}{{ loop.index }}:
                    <ul>
                      {%- for sf in field.repeating_subfields -%}
                        {%- set se_unprocessed = se.copy() -%}

                        {%- if 'error_snippet' in sf -%}
                          {%- set sfe_snippet = sf.error_snippet -%}

                          {%- if '/' not in sfe_snippet -%}
                            {%- set sfe_snippet = 'scheming/error_snippets/' +
                              sfe_snippet -%}
                          {%- endif -%}

                          {%- snippet sfe_snippet, unprocessed=se_unprocessed,
                            field=sf, fields=field.repeating_subfileds,
                            entity_type=entity_type, object_type=object_type -%}
                        {%- endif -%}

                        {%- if sf.field_name in se_unprocessed -%}
                          <li data-field-label="{{ field.field_name }}-{{ loop.index }}-{{ sf.field_name }}">{{
                            h.scheming_language_text(sf.label) }}:
                            {{ se_unprocessed[sf.field_name][0] }}</li>
                        {%- endif -%}
                      {%- endfor -%}
                    </ul>
                  </li>
                {%- endif -%}
              {%- endfor -%}
            {%- else -%}
              {# Missing mandatory fields #}
              <li data-field-label="{{ field.field_name }}">{{
                h.scheming_language_text(field.label) }}:
                {{ errors[0] }}</li>
            {%- endif -%}
          {%- endif -%}
        {%- endfor -%}

        {%- for key, errors in unprocessed.items() | sort -%}
          {% if key == "validation" %}
            <li data-field-label="{{ key }}">{{ errors[0] }}</li>
          {% else %}
            <li data-field-label="{{ key }}">{{ _(key) }}: {{ errors[0] }}</li>
          {% endif %}
        {%- endfor -%}
      {% endblock %}
    </ul>

    {% if validation_report %}
      {% if h.bootstrap_version() == '3' %}
        {% snippet 'validation/snippets/validation_report_dialog.html', validation_report=h.dump_json_value(validation_report) %}
      {% else %}
        {% snippet 'validation/snippets/validation_report_dialog_bs2.html', validation_report=h.dump_json_value(validation_report) %}
      {% endif %}
    {% endif %}
  </div>

{% endblock %}
